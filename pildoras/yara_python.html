<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Detecci√≥n de Malware con YARA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --border-color: #30363d;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        .navbar {
            background-color: var(--bg-secondary) !important;
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand, .nav-link {
            color: var(--text-primary) !important;
        }

        .nav-link:hover {
            color: var(--accent-blue) !important;
        }

        .container-fluid {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 2rem;
            padding: 2rem;
        }

        .card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            color: var(--accent-blue);
            font-weight: 600;
        }

        .card-body {
            color: var(--text-primary);
        }

        .badge {
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }

        .badge.bg-primary {
            background-color: var(--accent-blue) !important;
        }

        .badge.bg-success {
            background-color: var(--accent-green) !important;
        }

        .badge.bg-danger {
            background-color: var(--accent-red) !important;
        }

        .alert {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .alert-info {
            border-left: 4px solid var(--accent-blue);
        }

        .alert-warning {
            border-left: 4px solid #f1c40f;
        }

        .list-group-item {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .text-muted {
            color: var(--text-secondary) !important;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--text-primary);
        }

        .code-section {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        pre {
            background-color: transparent !important;
            border: none !important;
            margin: 0;
        }

        code {
            background-color: var(--bg-tertiary);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875rem;
        }

        .feature-icon {
            width: 24px;
            height: 24px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .function-card {
            transition: transform 0.2s ease;
        }

        .function-card:hover {
            transform: translateY(-2px);
        }

        .tech-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .workflow-step {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }

        .workflow-step::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            left: 0;
            top: 0;
            background-color: var(--accent-blue);
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .workflow-container {
            counter-reset: step-counter;
        }

        @media (max-width: 768px) {
            .container-fluid {
                margin-top: 1rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <strong>üõ°Ô∏è Sistema de Detecci√≥n de Malware</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#codigo">C√≥digo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#funcionalidad">Funcionalidad</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#tecnologias">Tecnolog√≠as</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#flujo">Flujo de Trabajo</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-4">
                    <h1 class="display-4 mb-3">Sistema de Detecci√≥n de Malware con YARA</h1>
                    <p class="lead text-muted">An√°lisis automatizado de archivos mediante reglas YARA y base de datos MongoDB</p>
                    <div class="mt-3">
                        <span class="badge bg-primary">Python 3.x</span>
                        <span class="badge bg-success">YARA Engine</span>
                        <span class="badge bg-danger">MongoDB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- C√≥digo Fuente -->
        <div class="row" id="codigo">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>üìÑ C√≥digo Fuente Completo</h3>
                    </div>
                    <div class="card-body">
                        <div class="code-section">
                            <pre><code class="language-python">import yara
import os
import pymongo

# Variables de configuraci√≥n MongoDB
MONGO_URI = "mongodb://localhost:27017"  # URI de conexi√≥n a MongoDB
DB_NAME = "memes"  # Nombre de la base de datos
COLLECTION_NAME = "metadata"  # Nombre de la colecci√≥n
RUTA_REGLAS = "./reglas"  # Ruta donde se encuentran las reglas YARA

def obtener_archivosde_mongodb():
    listado_archivos = []
    """
    Conecta a MongoDB y obtiene la lista de archivos en la colecci√≥n.
    
    Returns:
        list: Lista de archivos en la colecci√≥n
    """
    client = pymongo.MongoClient(MONGO_URI)
    db = client[DB_NAME]
    collection = db[COLLECTION_NAME]
    
    # Obtener todos los documentos en la colecci√≥n
    archivos = list(collection.find({}))
    
    for archivo in archivos:
        listado_archivos.append(archivo["ruta"])
        print(archivo["ruta"])        
    
    client.close()
    return listado_archivos

def obtener_lista_reglas_yara(ruta):
    lista= []
    for root, dir, filenames in os.walk(ruta):
        for filename in filenames:
            if filename.endswith('.yar') or filename.endswith('.yara'):
                lista.append(os.path.join(root, filename))
    return lista    

def scan_file_with_yara(filepath, rules_filepath):
    """
    Escanea un archivo dado utilizando un conjunto de reglas YARA.
    
    Args:
        filepath (str): La ruta al archivo que se desea escanear.
        rules_filepath (str): La ruta al archivo que contiene las reglas YARA (.yar).
    
    Returns:
        list: Una lista de objetos Match que representan las reglas que coincidieron.
              Devuelve una lista vac√≠a si no hay coincidencias o si hay un error.
    """
    if not os.path.exists(filepath):
        print(f"Error: El archivo '{filepath}' no existe.")
        return []
    
    if not os.path.exists(rules_filepath):
        print(f"Error: El archivo de reglas YARA '{rules_filepath}' no existe.")
        return []
    
    try:
        # Compila las reglas YARA desde el archivo
        rules = yara.compile(filepath=rules_filepath)       
        
        # Escanea el archivo y obtiene las coincidencias
        matches = rules.match(filepath=filepath)
        
        return matches
    
    except yara.Error as e:
        print(f"Error al compilar las reglas YARA o al escanear: {e}")
        return []
    except Exception as e:
        print(f"Ocurri√≥ un error inesperado: {e}")
        return []

if __name__ == "__main__":   
    archivos_a_escanear = obtener_archivosde_mongodb()
    
    for archivo_a_escanear in archivos_a_escanear:
        print(f"Escaneando archivo: {archivo_a_escanear}")
        rules_files = obtener_lista_reglas_yara(RUTA_REGLAS)
        
        for rule in rules_files:
            #print(f"Escaneando {archivo_a_escanear} con reglas {rule}")
            results = scan_file_with_yara(archivo_a_escanear, rule)
            
            if results:
                print(f"¬°Malware detectado en '{archivo_a_escanear}' con la regla '{rule}'!")
                for match in results:
                    print(f"  - Regla: {match.rule}")
                    print(f"  - Meta: {match.meta}")
                    print(f"  - Cadenas coincidentes: {match.strings}")                    
            else:
                #print(f"No se detect√≥ malware en '{archivo_a_escanear}' con la regla '{rule}'.")
                pass
    
    print("Escaneo completado.")</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Funcionalidad -->
        <div class="row" id="funcionalidad">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>‚öôÔ∏è Funcionalidad del Sistema</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>Descripci√≥n General:</strong> Este script implementa un sistema automatizado de detecci√≥n de malware que utiliza el motor de an√°lisis YARA para escanear archivos almacenados en una base de datos MongoDB.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card function-card">
                                    <div class="card-body">
                                        <h5>üóÉÔ∏è obtener_archivosde_mongodb()</h5>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item">Conecta con la base de datos MongoDB</li>
                                            <li class="list-group-item">Obtiene la lista de rutas de archivos desde la colecci√≥n 'metadata'</li>
                                            <li class="list-group-item">Retorna una lista con las rutas de todos los archivos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card function-card">
                                    <div class="card-body">
                                        <h5>üìã obtener_lista_reglas_yara()</h5>
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item">Escanea recursivamente el directorio de reglas</li>
                                            <li class="list-group-item">Identifica archivos con extensiones .yar y .yara</li>
                                            <li class="list-group-item">Retorna una lista con todas las reglas disponibles</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card function-card">
                                    <div class="card-body">
                                        <h5>üîç scan_file_with_yara()</h5>
                                        <p class="text-muted">Funci√≥n principal de an√°lisis que:</p>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item">Valida la existencia del archivo objetivo</li>
                                                    <li class="list-group-item">Verifica la disponibilidad de las reglas YARA</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-4">
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item">Compila las reglas YARA din√°micamente</li>
                                                    <li class="list-group-item">Ejecuta el an√°lisis del archivo</li>
                                                </ul>
                                            </div>
                                            <div class="col-md-4">
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item">Gestiona errores de compilaci√≥n y ejecuci√≥n</li>
                                                    <li class="list-group-item">Retorna los resultados de coincidencias</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tecnolog√≠as -->
        <div class="row" id="tecnologias">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>üîß Tecnolog√≠as Empleadas</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5>üêç Python 3.x</h5>
                                        <p class="text-muted">Lenguaje de programaci√≥n principal del sistema</p>
                                        <div class="tech-badge">Lenguaje Base</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5>üõ°Ô∏è YARA Engine</h5>
                                        <p class="text-muted">Motor de an√°lisis de malware mediante patrones y reglas</p>
                                        <div class="tech-badge">An√°lisis de Malware</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5>üóÑÔ∏è MongoDB</h5>
                                        <p class="text-muted">Base de datos NoSQL para almacenar metadatos de archivos</p>
                                        <div class="tech-badge">Base de Datos</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-4">
                            <h6><strong>Dependencias del Sistema:</strong></h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <code>pip install yara-python</code><br>
                                    <small class="text-muted">Motor YARA para Python</small>
                                </div>
                                <div class="col-md-4">
                                    <code>pip install pymongo</code><br>
                                    <small class="text-muted">Cliente MongoDB para Python</small>
                                </div>
                                <div class="col-md-4">
                                    <code>import os</code><br>
                                    <small class="text-muted">Biblioteca est√°ndar de Python</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flujo de Trabajo -->
        <div class="row" id="flujo">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>üîÑ Flujo de Trabajo del Sistema</h3>
                    </div>
                    <div class="card-body">
                        <div class="workflow-container">
                            <div class="workflow-step">
                                <h6><strong>Inicializaci√≥n del Sistema</strong></h6>
                                <p class="text-muted">El script establece la conexi√≥n con MongoDB usando la URI configurada y define las rutas de trabajo.</p>
                            </div>
                            <div class="workflow-step">
                                <h6><strong>Obtenci√≥n de Archivos</strong></h6>
                                <p class="text-muted">Se consulta la colecci√≥n 'metadata' en la base de datos 'memes' para obtener la lista de archivos a analizar.</p>
                            </div>
                            <div class="workflow-step">
                                <h6><strong>Carga de Reglas YARA</strong></h6>
                                <p class="text-muted">El sistema escanea recursivamente el directorio './reglas' buscando archivos .yar y .yara.</p>
                            </div>
                            <div class="workflow-step">
                                <h6><strong>An√°lisis Cruzado</strong></h6>
                                <p class="text-muted">Cada archivo se analiza contra todas las reglas YARA disponibles de forma sistem√°tica.</p>
                            </div>
                            <div class="workflow-step">
                                <h6><strong>Detecci√≥n y Reporte</strong></h6>
                                <p class="text-muted">Si se detecta malware, se muestran los detalles de la regla coincidente, metadatos y cadenas detectadas.</p>
                            </div>
                            <div class="workflow-step">
                                <h6><strong>Finalizaci√≥n</strong></h6>
                                <p class="text-muted">Una vez completado el an√°lisis de todos los archivos, el sistema muestra un mensaje de confirmaci√≥n.</p>
                            </div>
                        </div>

                        <div class="alert alert-info mt-4">
                            <h6><strong>Caracter√≠sticas de Seguridad:</strong></h6>
                            <ul class="mb-0">
                                <li><strong>Validaci√≥n de Archivos:</strong> Verifica la existencia de archivos antes del an√°lisis</li>
                                <li><strong>Gesti√≥n de Errores:</strong> Captura excepciones de YARA y errores generales</li>
                                <li><strong>An√°lisis Exhaustivo:</strong> Cada archivo se eval√∫a contra m√∫ltiples reglas</li>
                                <li><strong>Reporte Detallado:</strong> Proporciona informaci√≥n espec√≠fica sobre cada detecci√≥n</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n Adicional -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3>üìä Configuraci√≥n y Uso</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>‚öôÔ∏è Configuraci√≥n</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><code>MONGO_URI</code>: URI de conexi√≥n a MongoDB</li>
                                    <li class="list-group-item"><code>DB_NAME</code>: Base de datos "memes"</li>
                                    <li class="list-group-item"><code>COLLECTION_NAME</code>: Colecci√≥n "metadata"</li>
                                    <li class="list-group-item"><code>RUTA_REGLAS</code>: Directorio "./reglas"</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5>üöÄ Ejecuci√≥n</h5>
                                <div class="code-section">
                                    <pre><code>python malware_scanner.py</code></pre>
                                </div>
                                <p class="text-muted">El script se ejecuta autom√°ticamente al ser invocado, realizando un an√°lisis completo de todos los archivos registrados en MongoDB.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="py-4 mt-5" style="background: linear-gradient(135deg, #080505 0%, #09090f 100%); border-radius: 15px; margin-top: 20px;">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0 fw-bold">&copy; 2025 Benito Gonz√°lez Pi√±eiro.</p>
                </div>
                <div class="col-md-6 text-end">
                    <a href="pildoras.html" class="btn btn-dark">Ir a Pildoras</a>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
