<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial YARA - Guía Completa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 2em;
            color: #e0e0e0;
            background-color: #121212;
        }
        h1, h2 {
            color: #ffffff;
        }
        h1 {
            border-bottom: 2px solid #bb86fc;
            padding-bottom: 0.5em;
        }
        h2 {
            margin-top: 1.5em;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1e1e1e;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 1px solid #333;
        }
        code, pre {
            background-color: #2d2d2d;
            padding: 2px 6px;
            border-radius: 4px;
            color: #f44336;
            font-family: "Courier New", Courier, monospace;
            border: 1px solid #444;
        }
        pre {
            padding: 1em;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        .card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            margin-bottom: 1.5em;
            padding: 1.5em;
        }
        .card-body {
            color: #e0e0e0;
        }
        footer {
            color: #b0b0b0;
            border-top: 1px solid #444;
        }
        a {
            color: #bb86fc;
            text-decoration: none;
        }
        a:hover {
            color: #9d4edd;
        }
        strong {
            color: #ffffff;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>YARA</h1>
    <p>El patrón perfecto para la detección de malware</p>
    <div class="card">
        <div class="card-body">
            <h2>Contenidos</h2>
            <ol>
                <li>¿Qué es YARA?</li>
                <li>Instalación</li>
                <li>Sintaxis Básica</li>
                <li>Definiendo Strings</li>
                <li>Condiciones</li>
                <li>Metadatos</li>
                <li>Ejemplos Prácticos</li>
                <li>Uso de YARA</li>
                <li>Técnicas Avanzadas</li>
                <li>Herramientas Complementarias</li>
            </ol>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>¿Qué es YARA?</h2>
            <p>YARA es una herramienta diseñada para ayudar a los investigadores de malware a identificar y clasificar muestras de malware mediante la creación de descripciones de familias de malware basadas en patrones textuales o binarios.</p>

            <p><strong>En términos simples:</strong> YARA te permite crear "reglas" que describen patrones específicos. Cuando escaneas archivos con estas reglas, YARA te dice si encuentra esos patrones.</p>

            <h3>¿Para qué se utiliza?</h3>
            <ul>
                <li><strong>Detección de malware:</strong> Identificar virus, trojanos, ransomware, etc.</li>
                <li><strong>Análisis forense:</strong> Buscar evidencias en discos duros y memoria</li>
                <li><strong>Threat hunting:</strong> Caza proactiva de amenazas en redes</li>
                <li><strong>Clasificación automática:</strong> Categorizar automáticamente muestras de malware</li>
            </ul>

            <p><strong>¿Por qué YARA es genial?</strong></p>
            <ul>
                <li>Sintaxis simple y legible</li>
                <li>Muy rápido para escanear grandes volúmenes</li>
                <li>Flexible: texto, binario, expresiones regulares</li>
                <li>Ampliamente adoptado por la industria</li>
            </ul>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Instalación</h2>

            <h3>Ubuntu/Debian</h3>
            <pre><code>sudo apt update
sudo apt install yara</code></pre>

            <h3>CentOS/RHEL</h3>
            <pre><code>sudo yum install epel-release
sudo yum install yara</code></pre>

            <h3>macOS</h3>
            <pre><code>brew install yara</code></pre>

            <h3>Windows</h3>
            <p>Descarga el ejecutable desde: <a href="https://github.com/VirusTotal/yara/releases">github.com/VirusTotal/yara/releases</a></p>

            <h3>Verificar instalación</h3>
            <pre><code>yara --version</code></pre>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Sintaxis Básica</h2>

            <p>Una regla YARA tiene la siguiente estructura básica:</p>

            <pre><code>rule NombreDeLaRegla
{
    meta:
        description = "Descripción de la regla"
        author = "Tu nombre"
        date = "2024-01-01"
    
    strings:
        $cadena1 = "texto a buscar"
        $cadena2 = { 48 65 6C 6C 6F }  // bytes en hexadecimal
    
    condition:
        $cadena1 or $cadena2
}</code></pre>

            <h3>Componentes principales:</h3>
            <ul>
                <li><strong>rule:</strong> Palabra clave que inicia la regla seguida del nombre</li>
                <li><strong>meta:</strong> Metadatos descriptivos (opcional)</li>
                <li><strong>strings:</strong> Patrones a buscar en los archivos</li>
                <li><strong>condition:</strong> Lógica que determina cuándo la regla coincide</li>
            </ul>

            <p><strong>Importante:</strong></p>
            <ul>
                <li>Los nombres de reglas deben ser únicos</li>
                <li>Los identificadores de strings deben empezar con $</li>
                <li>La sección <code>condition</code> es obligatoria</li>
            </ul>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Definiendo Strings</h2>

            <h3>1. Strings de texto</h3>
            <pre><code>strings:
    $texto1 = "Hola mundo"
    $texto2 = "password"
    $texto3 = "malware" nocase    // insensible a mayúsculas
    $texto4 = "test" wide         // formato Unicode</code></pre>

            <h3>2. Strings hexadecimales</h3>
            <pre><code>strings:
    $hex1 = { 4D 5A }              // "MZ" en hexadecimal
    $hex2 = { 4D 5A ?? ?? 50 45 }  // ?? = cualquier byte
    $hex3 = { 4D 5A [0-100] 50 45} // salto de 0-100 bytes</code></pre>

            <h3>3. Expresiones regulares</h3>
            <pre><code>strings:
    $regex1 = /http:\/\/[a-z]+\.com/
    $regex2 = /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/  // IP
    $regex3 = /[a-zA-Z0-9]{32}/ nocase              // MD5 hash</code></pre>

            <h3>Modificadores útiles:</h3>
            <ul>
                <li><code>nocase</code>: Ignora mayúsculas/minúsculas</li>
                <li><code>wide</code>: Búsqueda en formato Unicode</li>
                <li><code>ascii</code>: Solo caracteres ASCII</li>
                <li><code>fullword</code>: Palabra completa</li>
                <li><code>xor</code>: Búsqueda con XOR</li>
                <li><code>base64</code>: Decodifica Base64</li>
                <li><code>base64wide</code>: Base64 + wide</li>
            </ul>

            <p><strong>Consejo Pro:</strong> Combina modificadores para mayor flexibilidad: <code>$string = "password" nocase wide ascii</code></p>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Condiciones</h2>

            <h3>Operadores lógicos básicos:</h3>
            <pre><code>condition:
    $string1 and $string2        // Ambos deben existir
    $string1 or $string2         // Al menos uno debe existir
    not $string1                 // No debe existir
    ($string1 and $string2) or $string3</code></pre>

            <h3>Contadores y rangos:</h3>
            <pre><code>condition:
    #string1 > 5                 // Más de 5 ocurrencias
    #string1 in (1..10)          // Entre 1 y 10 ocurrencias
    any of ($string*)            // Cualquier string que empiece con "string"
    all of them                  // Todos los strings definidos
    2 of ($a, $b, $c)           // Al menos 2 de los 3 strings</code></pre>

            <h3>Posición y tamaño del archivo:</h3>
            <pre><code>condition:
    $string1 at 0               // String en el byte 0 (inicio)
    $string1 at entrypoint      // String en el punto de entrada
    filesize > 1MB              // Archivo mayor a 1 MB
    filesize < 10KB             // Archivo menor a 10 KB</code></pre>

            <h3>Funciones útiles:</h3>
            <p><strong>Información PE:</strong></p>
            <pre><code>pe.number_of_sections > 3
pe.imports("kernel32.dll")</code></pre>

            <p><strong>Hash del archivo:</strong></p>
            <pre><code>hash.md5(0, filesize) == "abc123..."</code></pre>

            <p><strong>Matemáticas:</strong></p>
            <pre><code>math.entropy(0, filesize) > 7.5</code></pre>

            <p><strong>Tiempo:</strong></p>
            <pre><code>pe.timestamp > 1577836800</code></pre>

            <h3>Ejemplo avanzado:</h3>
            <pre><code>condition:
    (filesize > 10KB and filesize < 1MB) and
    (any of ($malware*) or #suspicious > 3) and
    pe.number_of_sections between 3 and 8</code></pre>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Metadatos</h2>

            <p>Los metadatos proporcionan información adicional sobre la regla sin afectar la lógica de detección:</p>

            <pre><code>rule MiReglaDetallada
{
    meta:
        description = "Detecta la familia de malware XYZ"
        author = "Tu Nombre <email@domain.com>"
        date = "2024-08-15"
        version = "1.2"
        severity = "high"
        family = "trojan"
        sample = "abc123def456..."
        reference = "https://blog.security.com/analysis"
        tags = "trojan,banking,stealer"
        tlp = "white"
    
    strings:
        // ... definiciones de strings
    
    condition:
        // ... condiciones
}</code></pre>

            <h3>Metadatos comunes y recomendados:</h3>
            <ul>
                <li><strong>description:</strong> Qué detecta la regla</li>
                <li><strong>author:</strong> Quién creó la regla</li>
                <li><strong>date:</strong> Fecha de creación</li>
                <li><strong>version:</strong> Versión de la regla</li>
                <li><strong>severity:</strong> Criticidad (low/medium/high)</li>
                <li><strong>family:</strong> Familia de malware</li>
                <li><strong>reference:</strong> Enlaces relacionados</li>
                <li><strong>sample:</strong> Hash de muestra</li>
                <li><strong>tags:</strong> Etiquetas para clasificación</li>
                <li><strong>tlp:</strong> Traffic Light Protocol</li>
            </ul>

            <p><strong>Buenas prácticas:</strong></p>
            <ul>
                <li>Siempre incluye <code>description</code>, <code>author</code> y <code>date</code></li>
                <li>Usa <code>tags</code> para facilitar la organización</li>
                <li>Incluye <code>reference</code> para análisis detallados</li>
                <li>Actualiza <code>version</code> cuando modifiques la regla</li>
            </ul>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Ejemplos Prácticos</h2>

            <h3>Ejemplo 1: Detector de ejecutables sospechosos</h3>
            <pre><code>rule Suspicious_PE_File
{
    meta:
        description = "Detecta ejecutables PE con strings sospechosos"
        author = "Security Analyst"
        date = "2024-08-15"
    
    strings:
        $mz = { 4D 5A }  // Firma MZ
        $pe = "PE"
        $sus1 = "keylogger" nocase
        $sus2 = "password" nocase
        $sus3 = "backdoor" nocase
        $sus4 = "rootkit" nocase
    
    condition:
        $mz at 0 and $pe and any of ($sus*)
}</code></pre>

            <h3>Ejemplo 2: Detector de ransomware</h3>
            <pre><code>rule Ransomware_Generic
{
    meta:
        description = "Detecta comportamientos típicos de ransomware"
        author = "Malware Hunter"
        severity = "high"
        family = "ransomware"
    
    strings:
        $ransom1 = "Your files have been encrypted" nocase
        $ransom2 = "pay bitcoin" nocase
        $ransom3 = "decrypt" nocase
        $ransom4 = "ransom" nocase
        $ext1 = ".locked"
        $ext2 = ".encrypted"
        $ext3 = ".crypto"
    
    condition:
        (2 of ($ransom*)) or 
        (any of ($ransom*) and any of ($ext*))
}</code></pre>

            <h3>Ejemplo 3: Detector de URLs maliciosas</h3>
            <pre><code>rule Malicious_URLs
{
    meta:
        description = "Detecta URLs con patrones sospechosos"
        author = "Web Security Team"
    
    strings:
        $url1 = /https?:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/
        $url2 = /bit\.ly\/[a-zA-Z0-9]{6,}/
        $url3 = /tinyurl\.com\/[a-zA-Z0-9]{6,}/
        $phish1 = "paypal-secure" nocase
        $phish2 = "bank-update" nocase
        $phish3 = "account-verify" nocase
    
    condition:
        any of ($url*) or any of ($phish*)
}</code></pre>

            <h3>Ejemplo 4: Detector de archivos PDF maliciosos</h3>
            <pre><code>rule Malicious_PDF
{
    meta:
        description = "Detecta PDFs con JavaScript sospechoso"
        author = "Document Security"
    
    strings:
        $pdf_header = "%PDF-"
        $js1 = "/JavaScript" nocase
        $js2 = "/JS" nocase
        $suspicious1 = "eval(" nocase
        $suspicious2 = "unescape(" nocase
        $suspicious3 = "String.fromCharCode(" nocase
        $action = "/OpenAction" nocase
    
    condition:
        $pdf_header at 0 and
        (any of ($js*)) and
        (any of ($suspicious*) or $action)
}</code></pre>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Uso de YARA</h2>

            <h3>Comandos básicos:</h3>

            <p><strong>1. Escanear un archivo:</strong></p>
            <pre><code>yara mi_regla.yar archivo_sospechoso.exe</code></pre>

            <p><strong>2. Escanear un directorio:</strong></p>
            <pre><code>yara -r mi_regla.yar /ruta/del/directorio/</code></pre>

            <p><strong>3. Usar múltiples reglas:</strong></p>
            <pre><code>yara regla1.yar regla2.yar archivo.exe</code></pre>

            <p><strong>Consejo:</strong> Para aprender más sobre YARA, consulta la <a href="https://virustotal.github.io/yara/">documentación oficial</a>.</p>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Técnicas Avanzadas</h2>

            <h3>Reglas con múltiples condiciones</h3>
            <pre><code>rule Advanced_YARA_Rule
{
    meta:
        description = "Regla avanzada para detectar malware específico"
        author = "Security Researcher"
        date = "2024-08-15"
    
    strings:
        $header = { 4D 5A }              // Firma MZ
        $pe = "PE"                       // Firma PE
        $signature1 = "malware_pattern_1" nocase
        $signature2 = /http:\/\/[a-z]+\.com/  // URL con expresión regular
    
    condition:
        $header at 0 and $pe and 
        (any of ($signature*) or #suspicious > 5)
}</code></pre>

            <h3>Uso de funciones avanzadas</h3>
            <pre><code>rule Complex_Analysis
{
    meta:
        description = "Análisis complejo de archivos"
        author = "Security Analyst"
    
    strings:
        $pattern1 = "suspicious_string" nocase
        $pattern2 = { 4D 5A [0-100] 50 45 }  // Saltando bytes
    
    condition:
        (filesize > 1KB and filesize < 10MB) and
        (pe.number_of_sections between 1 and 10) and
        (any of ($pattern*) or math.entropy(0, filesize) > 7.0)
}</code></pre>

            <p><strong>Recomendación:</strong> Combina diferentes técnicas para crear reglas más robustas y precisas.</p>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h2>Herramientas Complementarias</h2>

            <ul>
                <li><strong>YARA-GUI:</strong> Interfaz gráfica para crear y probar reglas YARA</li>
                <li><strong>YARA-Rule-Generator:</strong> Herramienta para generar reglas automáticamente</li>
            </ul>

            <h3>Recursos útiles:</h3>
            <ul>
                <li><a href="https://virustotal.github.io/yara/">Documentación oficial de YARA</a></li>
                <li><a href="https://github.com/Yara-Rules/rules">Repositorio de reglas YARA</a></li>
                <li><a href="https://www.malware-traffic-analysis.net/">Análisis de tráfico de malware</a></li>
            </ul>

            <p><strong>Recomendación:</strong> Practica con herramientas como YARA-GUI para aprender mejor las reglas.</p>
        </div>
    </div>

    <footer style="text-align: center; margin-top: 2em; padding-top: 1em; border-top: 1px solid #ccc;">
        <p><a href="./pildoras.html">Volver a la página principal de píldoras</a></p>
    </footer>
</div>
</body>
</html>
